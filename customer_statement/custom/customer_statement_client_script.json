{
 "doctype": "Client Script",
 "name": "Customer Statement Button",
 "dt": "Customer",
 "script_type": "Form",
 "script": "frappe.ui.form.on('Customer', {\n\trefresh: function(frm) {\n\t\tif (frm.doc.name) {\n\t\t\tfrm.add_custom_button(__('Customer Statement'), function() {\n\t\t\t\tgenerate_customer_statement(frm);\n\t\t\t}, __('Actions'));\n\t\t}\n\t}\n});\n\nfunction generate_customer_statement(frm) {\n\tvar dialog = new frappe.ui.Dialog({\n\t\ttitle: __('Customer Statement'),\n\t\tfields: [\n\t\t\t{\n\t\t\t\tlabel: __('From Date'),\n\t\t\t\tfieldname: 'from_date',\n\t\t\t\tfieldtype: 'Date',\n\t\t\t\tdefault: frappe.datetime.add_months(frappe.datetime.get_today(), -12),\n\t\t\t\treqd: 1\n\t\t\t},\n\t\t\t{\n\t\t\t\tlabel: __('To Date'),\n\t\t\t\tfieldname: 'to_date',\n\t\t\t\tfieldtype: 'Date',\n\t\t\t\tdefault: frappe.datetime.get_today(),\n\t\t\t\treqd: 1\n\t\t\t}\n\t\t],\n\t\tprimary_action_label: __('Generate Statement'),\n\t\tprimary_action: function() {\n\t\t\tvar values = dialog.get_values();\n\t\t\tif (!values.from_date || !values.to_date) {\n\t\t\t\tfrappe.msgprint({\n\t\t\t\t\ttitle: __('Validation Error'),\n\t\t\t\t\tmessage: __('Please select both From Date and To Date'),\n\t\t\t\t\tindicator: 'red'\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tdialog.hide();\n\t\t\t\n\t\t\tfrappe.show_alert({\n\t\t\t\tmessage: __('Generating statement...'),\n\t\t\t\tindicator: 'blue'\n\t\t\t});\n\t\t\t\n\t\t\tfrappe.call({\n\t\t\t\tmethod: 'customer_statement.report.customer_statement.get_customer_statement',\n\t\t\t\targs: {\n\t\t\t\t\tcustomer: frm.doc.name,\n\t\t\t\t\tfrom_date: values.from_date,\n\t\t\t\t\tto_date: values.to_date\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.hide_alert();\n\t\t\t\t\tif (r.message) {\n\t\t\t\t\t\tif (r.message.html_content) {\n\t\t\t\t\t\t\tshow_statement_dialog(r.message.html_content, r.message.data);\n\t\t\t\t\t\t} else if (r.message.data) {\n\t\t\t\t\t\t\tshow_statement_dialog('', r.message.data);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tfrappe.msgprint({\n\t\t\t\t\t\t\t\ttitle: __('Statement Generated'),\n\t\t\t\t\t\t\t\tmessage: __('Statement data retrieved successfully'),\n\t\t\t\t\t\t\t\tindicator: 'green'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\terror: function(r) {\n\t\t\t\t\tfrappe.hide_alert();\n\t\t\t\t\tfrappe.msgprint({\n\t\t\t\t\t\ttitle: __('Error'),\n\t\t\t\t\t\tmessage: __('Failed to generate statement: ') + (r.message || 'Unknown error'),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n\t\n\tdialog.show();\n}\n\nfunction show_statement_dialog(html_content, data) {\n\tvar title = __('Customer Statement');\n\tif (data && data.customer && data.customer.customer_name) {\n\t\ttitle += ' - ' + data.customer.customer_name;\n\t}\n\t\n\tvar dialog = new frappe.ui.Dialog({\n\t\ttitle: title,\n\t\tsize: 'large',\n\t\tfields: [\n\t\t\t{\n\t\t\t\tfieldtype: 'HTML',\n\t\t\t\toptions: html_content || '<div class=\"alert alert-info\">' + __('Statement data loaded successfully') + '</div>'\n\t\t\t}\n\t\t]\n\t});\n\t\n\tdialog.set_primary_action(__('Print'), function() {\n\t\tprint_statement(html_content);\n\t});\n\t\n\tdialog.show();\n}\n\nfunction print_statement(html_content) {\n\tvar print_window = window.open('', '_blank');\n\tif (print_window) {\n\t\tprint_window.document.write('<!DOCTYPE html><html><head><title>Customer Statement</title></head><body>' + html_content + '</body></html>');\n\t\tprint_window.document.close();\n\t\tprint_window.focus();\n\t\tsetTimeout(function() {\n\t\t\tprint_window.print();\n\t\t}, 250);\n\t} else {\n\t\tfrappe.msgprint(__('Please allow popups to print the statement'));\n\t}\n}"
}

